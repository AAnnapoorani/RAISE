<!DOCTYPE html>

<html class="light" lang="en">

<!-- ==========================================
     ADMIN DASHBOARD PAGE
     ==========================================
     Main admin dashboard with statistics and recent activity
     Features: Stats cards, recent requests, theme toggle
========================================== -->

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AAI Hardware - Admin Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Theme Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-hover": "#0e4bce",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "card-light": "#ffffff",
                        "card-dark": "#1e293b",
                        "text-main-light": "#0d121b",
                        "text-main-dark": "#f8fafc",
                        "text-muted-light": "#4c669a",
                        "text-muted-dark": "#94a3b8",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                },
            },
        }
        // Immediately check for saved theme preference
        const savedTheme = localStorage.getItem("theme");

        // Check if user previously chose dark mode OR if they haven't chosen but their OS is dark
        if (savedTheme === "dark" || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    </script>
    <style>
        /* Smooth hover animation */
        .animated-btn {
            transition: all .25s ease;
            transform-origin: center;
        }

        /* Hover grow + shadow */
        .animated-btn:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 25px rgba(0, 0, 0, .08);
        }

        /* Active click ripple */
        .animated-btn:active {
            transform: scale(.97);
        }

        /* glowing primary hover */
        .glow-primary:hover {
            box-shadow: 0 0 0 6px rgba(19, 91, 236, 0.12);
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .sidebar-active {
            background: linear-gradient(120deg, #135bec, #0e4bce);
            color: white !important;
            box-shadow: 0 10px 20px rgba(19, 91, 236, .25);
        }

        .card-hover {
            transition: all .3s ease;
        }

        .card-hover:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 40px rgba(0, 0, 0, .12);
        }

        .chart-bar-h {
            transition: width 0.6s ease-in-out;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark font-display antialiased overflow-hidden">
    <script src="components/toast.js"></script>
    <script src="config.js"></script>

    <!-- Full Flex container -->
    <div class="flex h-screen w-full">

        <!-- SECTION: Sidebar navigation -->
        <!-- Sidebar -->
        <aside
            class="w-64 h-full flex flex-col bg-card-light dark:bg-card-dark border-r border-border-light dark:border-border-dark flex-shrink-0 z-20">
            <div class="p-6 flex items-center gap-3">
                <div class="p-2 rounded-lg flex items-center justify-center">
                    <img src="logo.jpeg" class="w-10 h-10 object-cover rounded" alt="icon">
                </div>
                <div>
                    <a href="Ad-dash.html">
                        <h1 class="text-base font-bold leading-none tracking-tight">AAI Hardware</h1>
                    </a>
                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">Admin Portal</p>
                </div>
            </div>
            <nav class="flex-1 px-4 py-4 flex flex-col gap-2 overflow-y-auto">
                <a href="Ad-dash.html"
                    class="sidebar-link sidebar-active flex items-center gap-3 px-3 py-2.5 rounded-lg">
                    <span class="material-symbols-outlined" style="font-size: 20px;">dashboard</span>
                    <span class="text-sm font-medium">Dashboard</span>
                </a>


                <a href="Ad-ticket.html" class="sidebar-link  flex items-center gap-3 px-3 py-2.5 rounded-lg">
                    <span class="material-symbols-outlined" style="font-size: 20px;">confirmation_number</span>
                    <span class="text-sm font-medium">Ticket Management</span>
                </a>

   
                <a href="Ad-inventory.html" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg">
                    <span class="material-symbols-outlined" style="font-size: 20px;">inventory_2</span>
                    <span class="text-sm font-medium">Inventory</span>
                </a>

                <div class="my-2 border-t border-border-light dark:border-border-dark"></div>
                <a href="Ad-settings.html" class="sidebar-link  flex items-center gap-3 px-3 py-2.5 rounded-lg">
                    <span class="material-symbols-outlined" style="font-size: 20px;">settings</span>
                    <span class="text-sm font-medium">Settings</span>
                </a>
            </nav>


            <a href="Ad-profile_dashboard.html"
                class="animated-btn gap-4 border-t border-border-light dark:border-border-dark block">
                <div
                    class="flex items-center gap-3 p-2 rounded-lg hover:bg-background-light dark:hover:bg-background-dark cursor-pointer transition-colors">
                    <div class="relative w-10 h-10 rounded-full overflow-hidden bg-gray-200">
                        <img alt="Admin user profile picture" class="object-cover w-full h-full"
                            src="https://ui-avatars.com/api/?name=Admin&background=random" id="admin-profile-pic" />
                    </div>
                    <div class="flex flex-col overflow-hidden">
                        <p id="admin-name-sidebar" class="text-sm font-bold truncate">Loading...</p>
                        <p id="admin-role-sidebar"
                            class="text-xs text-text-muted-light dark:text-text-muted-dark truncate">...</p>
                    </div>
                </div>
            </a>
        </aside> 

        <!-- SECTION: Main content area -->
        <!-- Main Content Wrapper -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Top Header -->
            <header
                class="h-16 flex items-center justify-between px-6 bg-card-light dark:bg-card-dark border-b border-border-light dark:border-border-dark flex-shrink-0">
                <!-- Search -->
                <div class="flex items-center w-full max-w-md">
                    <div class="relative w-full">
                        <span
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted-light dark:text-text-muted-dark material-symbols-outlined text-[20px]">
                            search
                        </span>
                        <input id="dashboard-search" onkeyup="filterDashboardTable()"
                            class="w-full pl-10 pr-4 py-2 rounded-lg bg-background-light dark:bg-background-dark border-none focus:ring-2 focus:ring-primary text-sm text-text-main-light dark:text-text-main-dark placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark"
                            placeholder="Search tickets, technicians..." type="text" />
                    </div>
                </div>
                <!-- Right Actions -->
                <div class="flex items-center gap-4">
                    <button id="dateButton"
                        class="animated-btn flex items-center gap-2 px-3 py-2 rounded-lg bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                        <span id="dateText"></span>
                    </button>
                    <button onclick="handleLogout()"
                        class="animated-btn flex items-center gap-2 px-3 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-all">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark p-6 lg:p-10">
                <div class="max-w-7xl mx-auto flex flex-col gap-8">

                    <!-- Page Heading -->
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-bold tracking-tight text-text-main-light dark:text-text-main-dark">
                                Welcome back, <span id="welcome-message">Admin</span>
                            </h2>
                            <p class="text-text-muted-light dark:text-text-muted-dark mt-1">Real-time maintenance
                                metrics and technician status.</p>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div
                            class="card-hover bg-card-light dark:bg-card-dark rounded-xl p-6 border border-border-light dark:border-border-dark shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg text-primary">
                                    <span class="material-symbols-outlined">confirmation_number</span>
                                </div>
                                <span
                                    class="flex items-center text-xs font-bold text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full">
                                    <span class="material-symbols-outlined text-[14px] mr-1">trending_up</span>
                                    Live
                                </span>
                            </div>
                            <h3 class="text-text-muted-light dark:text-text-muted-dark text-sm font-medium">Total
                                Requests</h3>
                            <p id="total-requests-count"
                                class="text-3xl font-bold mt-1 text-text-main-light dark:text-text-main-dark">...</p>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-2">All time</p>
                        </div>

                        <div
                            class="card-hover bg-card-light dark:bg-card-dark rounded-xl p-6 border border-border-light dark:border-border-dark shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded-lg text-red-600">
                                    <span class="material-symbols-outlined">warning</span>
                                </div>
                                <span
                                    class="flex items-center text-xs font-bold text-red-600 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded-full">
                                    Action Needed
                                </span>
                            </div>
                            <h3 class="text-text-muted-light dark:text-text-muted-dark text-sm font-medium">Pending
                                Requests</h3>
                            <p id="urgent-tickets-count"
                                class="text-3xl font-bold mt-1 text-text-main-light dark:text-text-main-dark">...</p>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-2">Awaiting approval
                            </p>
                        </div>

                        <div
                            class="card-hover bg-card-light dark:bg-card-dark rounded-xl p-6 border border-border-light dark:border-border-dark shadow-sm">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-purple-50 dark:bg-purple-900/20 p-2 rounded-lg text-purple-600">
                                    <span class="material-symbols-outlined">task_alt</span>
                                </div>
                                <span
                                    class="flex items-center text-xs font-bold text-text-muted-light dark:text-text-muted-dark bg-background-light dark:bg-gray-700 px-2 py-1 rounded-full">
                                    Completed
                                </span>
                            </div>
                            <h3 class="text-text-muted-light dark:text-text-muted-dark text-sm font-medium">Completed
                                Requests</h3>
                            <p class="text-3xl font-bold mt-1 text-text-main-light dark:text-text-main-dark">
                                <span id="completed-requests-count">...</span>
                            </p>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-2">Closed tickets</p>
                        </div>

                    </div>

                    <!-- Recent Activity Table -->
                    <div
                        class="bg-card-light dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark overflow-hidden shadow-sm">
                        <div
                            class="p-6 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                            <h3 class="text-lg font-bold text-text-main-light dark:text-text-main-dark">Recent Tickets
                            </h3>
                            <a href="Ad-export.html">
                                <button
                                    class="animated-btn glow-primary flex items-center gap-2 bg-primary hover:bg-primary-hover text-white px-4 py-2.5 rounded-lg shadow-sm shadow-primary/30 transition-all text-sm font-bold">
                                    <span class="material-symbols-outlined text-[20px]">download</span>
                                    Export Report
                                </button>
                            </a>
                            <a class="text-sm font-semibold text-primary hover:text-primary-hover"
                                href="Ad-ticket.html">View All</a>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-text-muted-light dark:text-text-muted-dark">
                                <thead
                                    class="bg-background-light dark:bg-background-dark text-xs uppercase font-bold text-text-main-light dark:text-text-main-dark">
                                    <tr>
                                        <th class="px-6 py-4">Ticket ID</th>
                                        <th class="px-6 py-4">Issue / Asset</th>
                                        <th class="px-6 py-4">Employee ID</th>
                                        <th class="px-6 py-4">Assignment</th>
                                        <th class="px-6 py-4">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-table-body"
                                    class="divide-y divide-border-light dark:divide-border-dark">
                                    <tr>
                                        <td colspan="5"
                                            class="px-6 py-8 text-center text-text-muted-light dark:text-text-muted-dark">
                                            Loading recent requests...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>

        // --- SEARCH / FILTER FUNCTION ---
        function filterDashboardTable() {
            // 1. Get the search term
            const input = document.getElementById("dashboard-search");
            const filter = input.value.toLowerCase();

            // 2. Get the table and rows
            const tableBody = document.getElementById("activity-table-body");
            const rows = tableBody.getElementsByTagName("tr");

            // 3. Loop through all rows and hide those that don't match
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // Get all text content in this row
                const textContent = row.textContent || row.innerText;

                if (textContent.toLowerCase().indexOf(filter) > -1) {
                    row.style.display = ""; // Show
                } else {
                    row.style.display = "none"; // Hide
                }
            }
        }

        // Load Admin Details from LocalStorage
        function loadAdminDetails() {
            // 1. Get user data from LocalStorage (saved during login)
            const user = JSON.parse(localStorage.getItem("user"));

            if (user) {
                // 2. Update Sidebar Name & Role
                document.getElementById("admin-name-sidebar").innerText = user.name || "Admin";
                document.getElementById("admin-role-sidebar").innerText = user.role || "Administrator";

                // 3. Update Welcome Message
                document.getElementById("welcome-message").innerText = user.name || "Admin";

                // Optional: Generate a dynamic profile pic based on initials
                if (user.name) {
                    document.getElementById("admin-profile-pic").src =
                        `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=0D8ABC&color=fff`;
                }
            }
        }

        // Call this function when the page loads
        loadAdminDetails();

        // Auth Check (Protect the page)
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || user.role !== "Admin") {
            window.location.href = "AdminLogin.html";
        }

        // Fetch Dashboard Data
        async function loadDashboard() {
            try {
                const response = await fetch("/api/dashboard/stats");
                const data = await response.json();

                // Update KPI Cards
                if (data) {
                    document.getElementById("total-requests-count").innerText = data.total || 0;
                    document.getElementById("urgent-tickets-count").innerText = data.pending || 0;
                    document.getElementById("completed-requests-count").innerText = data.completed || 0;
                }

                // Populate Table
                const tableBody = document.getElementById("activity-table-body");
                tableBody.innerHTML = ""; // Clear loading state

                for (const req of data.recent_activity) {

                    const adminLocked = req.assigned || req.status === "Completed";

                    // Use stored asset_name from hardware_request; fallback to asset_id
                    const issueLabel = req.asset_name || `Asset ${req.asset_id || "N/A"}`;

                    // Format Date
                    const dateObj = new Date(req.order_date);
                    const timeAgo = Math.floor((new Date() - dateObj) / 60000) + " mins ago"; // Simple calc

                    // Determine Status Color
                    let statusColor = "bg-yellow-100 text-yellow-800"; // Default Pending
                    if (req.status === "Approved") statusColor = "bg-blue-100 text-blue-800";
                    if (req.status === "Completed") statusColor = "bg-green-100 text-green-800";
                    if (req.status === "Rejected") statusColor = "bg-red-100 text-red-800";

                    const row = `
            <tr class="hover:bg-background-light/50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="px-6 py-4 font-medium">#${req.request_id}</td>
                <td class="px-6 py-4">Request for ${issueLabel}</td>
                <td class="px-6 py-4">${req.emp_id}</td>
                <td class="px-6 py-4">
                    <select onchange="updateAssignment('${req.request_id}', this.value)" ${adminLocked ? 'disabled' : ''} class="w-full rounded-md border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-sm py-1 px-2 ${adminLocked ? 'cursor-not-allowed opacity-70' : ''}">
                        <option value="Unassigned" ${!req.assigned ? 'selected' : ''}>Unassigned</option>
                        <option value="Assigned" ${req.assigned ? 'selected' : ''}>Assigned</option>
                    </select>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold ${statusColor}">
                        ${req.status}
                    </span>
                </td>
            </tr>
                `;
                    tableBody.innerHTML += row;
                }

            } catch (error) {
                console.error("Error loading dashboard:", error);
            }
        }

        // Run on load and refresh every 10s for live data
        loadDashboard();
        setInterval(loadDashboard, 10000);

        // Update assignment (Assigned / Unassigned) for a request
        async function updateAssignment(requestId, value) {
            try {
                const assigned = value === 'Assigned';
                const res = await fetch(`/api/tickets/${requestId}/assignment`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assigned })
                });
                if (res.ok) {
                    loadDashboard();
                } else {
                    alert('Failed to update assignment');
                }
            } catch (err) {
                console.error('Error updating assignment:', err);
            }
        }

        // Date Formatting
        function formatDate(date) {
            return date.toLocaleDateString("en-US", {
                month: "short",
                day: "2-digit",
                year: "numeric"
            });
        }

        // set current date
        function setToday() {
            const today = new Date();
            document.getElementById("dateText").innerText = formatDate(today);
        }

        // run on load
        setToday();

        // optional: refresh at midnight automatically
        setInterval(setToday, 60000);

        // Logout Function
        function handleLogout() {
            // Clear user data from LocalStorage
            localStorage.removeItem("user");
            // Redirect to login page
            window.location.href = "AdminLogin.html";
        }

        // Sidebar link active state handling
        const links = document.querySelectorAll(".sidebar-link");

        links.forEach(link => {
            link.addEventListener("click", () => {
                links.forEach(l => l.classList.remove("sidebar-active"));
                link.classList.add("sidebar-active");
            });
        });

    </script>

</body>

</html>