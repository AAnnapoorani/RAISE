<!DOCTYPE html>
<html class="light" lang="en">

<!-- ==========================================
     EXPORT DATA PAGE
     ==========================================
     Interface for exporting inventory and request data with real data from backend
     Features: Data export, format selection, download options
========================================== -->

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AAI Hardware - Export Code</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="components/toast.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-hover": "#0e4bce",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "card-light": "#ffffff",
                        "card-dark": "#1e293b",
                        "text-main-light": "#0d121b",
                        "text-main-dark": "#f8fafc",
                        "text-muted-light": "#4c669a",
                        "text-muted-dark": "#94a3b8",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                },
            },
        }
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark" || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark font-display antialiased overflow-hidden relative">
    <!-- SECTION: Export modal overlay -->
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6" id="export-modal">
        <div class="absolute inset-0 bg-background-light/60 dark:bg-background-dark/60 backdrop-blur-sm transition-opacity"></div>
        <div class="relative w-full max-w-lg max-h-screen overflow-y-auto transform rounded-2xl bg-card-light dark:bg-card-dark p-8 text-left shadow-2xl ring-1 ring-black/5 transition-all">
            <a href="Ad-dash.html">
                <button class="absolute top-4 right-4 rounded-full p-2 text-text-muted-light hover:bg-background-light dark:text-text-muted-dark dark:hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </a>
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="bg-primary/10 p-2 rounded-lg text-primary">
                        <span class="material-symbols-outlined">download</span>
                    </div>
                    <h3 class="text-xl font-bold text-text-main-light dark:text-text-main-dark">Export Report</h3>
                </div>
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark ml-11">Select date range and format to export ticket data.</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-text-main-light dark:text-text-main-dark mb-2">Date Range</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted-light material-symbols-outlined text-[18px]">calendar_month</span>
                        <select id="dateRange" class="w-full rounded-lg border border-border-light dark:border-gray-700 bg-background-light dark:bg-gray-800 text-sm py-2.5 pl-10 pr-3 focus:ring-2 focus:ring-primary focus:border-primary">
                            <option>All Tickets</option>
                            <option>Last 7 Days</option>
                            <option>Last 30 Days</option>
                            <option>This Month</option>
                            <option>Last Quarter</option>
                            <option>Custom Range</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Date Range Picker (Hidden by default) -->
                <div id="customDatePicker" class="hidden space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-text-main-light dark:text-text-main-dark mb-1">From Date</label>
                        <input type="date" id="fromDate" class="w-full rounded-lg border border-border-light dark:border-gray-700 bg-background-light dark:bg-gray-800 text-sm py-2 px-3 focus:ring-2 focus:ring-primary focus:border-primary" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-text-main-light dark:text-text-main-dark mb-1">To Date</label>
                        <input type="date" id="toDate" class="w-full rounded-lg border border-border-light dark:border-gray-700 bg-background-light dark:bg-gray-800 text-sm py-2 px-3 focus:ring-2 focus:ring-primary focus:border-primary" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-text-main-light dark:text-text-main-dark mb-3">Export Format</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="cursor-pointer border border-border-light dark:border-gray-700 rounded-lg p-3 flex flex-col items-center gap-2 hover:bg-background-light dark:hover:bg-gray-800 has-[:checked]:border-primary has-[:checked]:bg-primary/5 has-[:checked]:text-primary transition-all">
                            <input checked id="format-pdf" class="hidden" name="format" type="radio" value="pdf" />
                            <span class="material-symbols-outlined text-2xl text-red-500">picture_as_pdf</span>
                            <span class="text-xs font-medium">PDF</span>
                        </label>
                        <label class="cursor-pointer border border-border-light dark:border-gray-700 rounded-lg p-3 flex flex-col items-center gap-2 hover:bg-background-light dark:hover:bg-gray-800 has-[:checked]:border-primary has-[:checked]:bg-primary/5 has-[:checked]:text-primary transition-all">
                            <input id="format-excel" class="hidden" name="format" type="radio" value="excel" />
                            <span class="material-symbols-outlined text-2xl text-green-600">table_view</span>
                            <span class="text-xs font-medium">Excel</span>
                        </label>
                        <label class="cursor-pointer border border-border-light dark:border-gray-700 rounded-lg p-3 flex flex-col items-center gap-2 hover:bg-background-light dark:hover:bg-gray-800 has-[:checked]:border-primary has-[:checked]:bg-primary/5 has-[:checked]:text-primary transition-all">
                            <input id="format-csv" class="hidden" name="format" type="radio" value="csv" />
                            <span class="material-symbols-outlined text-2xl text-blue-500">description</span>
                            <span class="text-xs font-medium">CSV</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex items-center justify-end gap-3 pt-6 border-t border-border-light dark:border-border-dark">
                <a href="Ad-dash.html">
                    <button class="px-4 py-2 text-sm font-semibold text-text-muted-light hover:text-text-main-light dark:text-text-muted-dark dark:hover:text-text-main-dark transition-colors">
                        Cancel
                    </button>
                </a>
                <button id="exportBtn" class="px-6 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white text-sm font-bold shadow-md shadow-primary/20 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">export_notes</span>
                    Export
                </button>
            </div>
        </div>
    </div>

    <script>
        // Show/Hide custom date picker
        document.getElementById('dateRange').addEventListener('change', function() {
            const customPicker = document.getElementById('customDatePicker');
            customPicker.classList.toggle('hidden', this.value !== 'Custom Range');
        });

        // Calculate date range
        function getDateRange() {
            const selection = document.getElementById('dateRange').value;
            const today = new Date();
            let fromDate, toDate = new Date();

            if (selection === 'Custom Range') {
                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;
                if (!from || !to) {
                    alert('Please select both From and To dates.');
                    return null;
                }
                return { from, to, label: `${from} to ${to}` };
            }

            if (selection === 'All Tickets') {
                return { from: null, to: null, label: 'All' };
            }

            switch(selection) {
                case 'Last 7 Days':
                    fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'Last 30 Days':
                    fromDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'This Month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'Last Quarter':
                    fromDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            }

            return {
                from: fromDate.toISOString().split('T')[0],
                to: toDate.toISOString().split('T')[0],
                label: selection
            };
        }

        function toCSV(headers, rows) {
            const escape = v => '"' + String(v).replace(/"/g, '""') + '"';
            const lines = [headers.map(escape).join(',')];
            rows.forEach(r => lines.push(r.map(escape).join(',')));
            return lines.join('\n');
        }

        function downloadFile(filename, content, mime) {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function exportToPDF(headers, rows, dateRange) {
            const w = window.open('', '_blank');
            if (!w) {
                alert('Please allow popups.');
                return;
            }
            
            let html = `<!doctype html><html><head><title>Ticket Report</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 40px; }
                    h1 { color: #135bec; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background: #135bec; color: white; }
                    tr:nth-child(even) { background: #f9f9f9; }
                </style>
            </head><body>
                <h1>Ticket Export Report</h1>
                <p>Range: ${dateRange.label} | Generated: ${new Date().toLocaleDateString()}</p>
                <table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
                </table>
            </body></html>`;
            
            w.document.write(html);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        // Export button handler
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const dateRange = getDateRange();
            if (!dateRange) return;

            const format = document.querySelector('input[name="format"]:checked').value;
            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">hourglass_bottom</span> Exporting...';
            
            try {
                // Build query
                let url = '/api/export/data';
                if (dateRange.from && dateRange.to) {
                    url += `?from=${dateRange.from}&to=${dateRange.to}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (!result.success || result.count === 0) {
                    alert('No data found for the selected date range.');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">export_notes</span> Export';
                    return;
                }

                const headers = ['Ticket ID', 'Asset', 'Employee', 'Status', 'Priority', 'Assigned', 'Date', 'Description'];
                const rows = result.data.map(t => [
                    `#${t.request_id}`,
                    t.asset_name,
                    t.emp_id,
                    t.status,
                    t.priority,
                    t.assigned,
                    t.createdAt,
                    t.description
                ]);

                const timestamp = new Date().toISOString().slice(0, 10);
                
                if (format === 'csv') {
                    const csv = toCSV(headers, rows);
                    downloadFile(`ticket_report_${timestamp}.csv`, csv, 'text/csv;charset=utf-8;');
                    showToast(`✓ CSV exported (${rows.length} records)`);
                } else if (format === 'excel') {
                    const csv = toCSV(headers, rows);
                    downloadFile(`ticket_report_${timestamp}.xls`, csv, 'application/vnd.ms-excel');
                    showToast(`✓ Excel exported (${rows.length} records)`);
                } else if (format === 'pdf') {
                    exportToPDF(headers, rows, dateRange);
                    showToast(`✓ PDF ready (${rows.length} records)`);
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">export_notes</span> Export';
            }
        });
    </script>
</body>
</html>
